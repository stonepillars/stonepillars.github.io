var triggerError=attachErrorHandler("tooltipDebug",!0,function(t){if("Script error."===t)return!0}),animatePopup=window._animatePopup,escaper=encodeURIComponent||escape,decoder=decodeURIComponent||unescape;function getParameterByName(t,o){t=t.replace(/[\[\]]/g,"\\$&");o=new RegExp(t+"(=([^&;#]*)|&|#|$)").exec(o);return o?o[2]?decoder(o[2].replace(/\+/g," ")):"":null}function htmlEntities(t){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function htmlDecode(t){return $("<textarea/>").html(t).text()}var tooltip={loaded:!1,mapInterface:{parent:"",control:"",helper:""},map:null,tileSize:32,interface:"",params:{},options:{},pinned:!1,clientViewX:0,clientViewY:0,padding:2,maxWidth:0,$docBody:null,$wrap:null,$content:null,$title:null,$body:null,mapOffsets:{x:0,y:0,w:0,h:0},screenProperties:{x:0,y:0},showDelay:100,showDelayInt:0,interrupt:!1,init:function(t,o,i,e){tooltip.screenProperties=t,tooltip.tileSize=parseInt(o),tooltip.interface=i;try{tooltip.mapInterface=$.parseJSON(e)}catch(t){return void triggerError("(init map) JSON parse error for: "+e+". "+t)}tooltip.maxWidth=parseInt(tooltip.$wrap.css("max-width"))},getMapControlFor:function(t){var o=tooltip.mapInterface.parent+".";switch(t){case"map":o+=tooltip.mapInterface.control;break;case"helper":o+=tooltip.mapInterface.helper}return o},removeDelays:function(){clearTimeout(tooltip.showDelayInt)},unInterrupt:function(){tooltip.interrupt=!1,tooltip.removeDelays()},setInterrupt:function(t){tooltip.interrupt="1"===t},hide:function(){tooltip.removeDelays(),animatePopup.stop(),window.location="?src="+window.tooltipRef+";action=hide;force=1"},log:function(t){window.location="?src="+window.tooltipRef+";action=log&msg="+escaper(t)},debugLog:function(t){window.tooltipDebug&&tooltip.log(t)},show:function(t,o,i,e){if(tooltip.interrupt)return tooltip.unInterrupt();window.location="byond://winset?id="+tooltip.interface+";size="+t+"x"+o+";pos="+i+","+e+";alpha=255",tooltip.options.hasOwnProperty("transition")&&animatePopup.isValidAnimation(tooltip.options.transition)&&animatePopup.run(tooltip.options.transition,{logger:tooltip.log,interface:tooltip.interface,duration:500,complete:function(){tooltip.debugLog(tooltip.options.transition+" animation complete")}}),$(window).off("keypress").one("keypress",function(t){$(t.target).is("input, textarea, select, option, button")||(window.location="byond://winset?"+tooltip.getMapControlFor("map")+".focus=true")}),tooltip.pinned?($(".close-tip").show().off("click").one("click",function(t){t.preventDefault(),tooltip.debugLog("tooltip hide called from click event"),tooltip.hide()}),$(window).off("click").on("click",function(t){$(t.target).is("input, textarea, select, option, button")||(window.location="byond://winset?"+tooltip.getMapControlFor("map")+".focus=true")})):tooltip.$content.off("mouseover").one("mouseover",function(){tooltip.debugLog("tooltip hide called from mouseover event"),tooltip.hide()})},position:function(o){if(o)try{tooltip.params=$.parseJSON(o)}catch(t){return void triggerError("(position params) JSON parse error for: "+o+". "+t)}var t=tooltip.map.viewSize.x,i=tooltip.map.viewSize.y,e=2*tooltip.clientViewX+1,p=2*tooltip.clientViewY+1,n=t/e,r=i/p,a=n/tooltip.tileSize,l=r/tooltip.tileSize,s=(tooltip.map.size.x-t)/2,c=(tooltip.map.size.y-i)/2,d=tooltip.params.cursor,u=parseInt(getParameterByName("icon-x",d)),t=parseInt(getParameterByName("icon-y",d)),i=getParameterByName("screen-loc",d);if(!u||!t||!i)return!1;if((i=i.split(",")).length<2)return!1;d=i[0],u=i[1];if(!d||!u)return!1;i=d.split(":"),d=parseInt(i[0]),parseInt(i[1]);i=u.split(":");u=parseInt(i[0]),parseInt(i[1]);tooltip.options.hasOwnProperty("special")&&"pod"===tooltip.options.special&&u--;t=u;tooltip.options.hasOwnProperty("offset")&&(tooltip.options.offset.hasOwnProperty("x")&&(s+=(i=parseInt(tooltip.options.offset.x))*a,tooltip.debugLog("Manually adjusted leftOffset by "+i+" amount. Real pixel offset value: "+i*a)),tooltip.options.offset.hasOwnProperty("y")&&(c+=(a=parseInt(tooltip.options.offset.y))*l,tooltip.debugLog("Manually adjusted topOffset by "+a+" amount. Real pixel offset value: "+a*l))),d=d<0?0:e<d?e:d,u=u<0?0:p<u?p:u;var f,e=Math.round((d-1)*n+s+tooltip.padding),d=Math.round((p-u+1)*r+c+tooltip.padding),s=0,p=0;tooltip.$wrap.attr("style",""),tooltip.options.hasOwnProperty("size")&&"string"==typeof tooltip.options.size?(f=(u=tooltip.options.size.split("x"))[0].toLowerCase(),c=u[1].toLowerCase(),s="auto"===f?tooltip.$wrap.outerWidth():parseInt(u[0]),p="auto"===c?tooltip.$wrap.outerHeight():parseInt(u[1]),"auto"!==f&&tooltip.$wrap.css("min-width",s)):(s=tooltip.$wrap.outerWidth()+2,p=tooltip.$wrap.outerHeight()),tooltip.$wrap.attr("style","width: "+s+"px; height: "+p+"px;"),tooltip.params.hasOwnProperty("flags")&&0<tooltip.params.flags.length&&(f="bottom",-1!==$.inArray("top",tooltip.params.flags)&&(f="top",d=d-p-r-2*tooltip.padding),-1!==$.inArray("top2",tooltip.params.flags)&&(f="top",d=d-p-r-2*tooltip.padding,t<=1&&(d-=r)),-1!==$.inArray("right",tooltip.params.flags)&&(f="right",e+=n,d-=r),-1!==$.inArray("left",tooltip.params.flags)&&(f="left",e=e-s-2*tooltip.padding,d-=r),-1!==$.inArray("center",tooltip.params.flags)&&("bottom"===f||"top"===f?(e=e+n/2-s/2)<tooltip.padding&&(e=tooltip.padding):0<(n=r-p)&&(d+=n/2)));e=e+tooltip.mapOffsets.x-tooltip.screenProperties.x,d=d+tooltip.mapOffsets.y-tooltip.screenProperties.y;tooltip.map.size.y+(tooltip.mapOffsets.y-tooltip.screenProperties.y)<d+p&&(d=d-p-r-tooltip.padding);r=tooltip.map.size.x+(tooltip.mapOffsets.x-tooltip.screenProperties.x);r<e+s&&(e=e-(e+s-r)-2*tooltip.padding),tooltip.debugLog("Position called. Width: "+s+". Height: "+p+". PosX: "+e+". PosY: "+d),tooltip.show(s,p,e,d)},changeContent:function(t,o){t=htmlDecode(t),o=htmlDecode(o),tooltip.options.title=t,tooltip.options.content=o,tooltip.$content.empty(),void 0!==t&&(tooltip.$title=$("<h1>",{class:"title",html:t}),tooltip.$content.append(tooltip.$title)),void 0!==o&&(tooltip.$body=$("<div>",{html:o}),tooltip.$content.append(tooltip.$body)),tooltip.$content.waitForImages(function(){tooltip.showDelayInt=setTimeout(function(){tooltip.position()},tooltip.showDelay)})},updateCallback:function(o){if(void 0===o||!o)return!1;tooltip.map={size:o[tooltip.getMapControlFor("helper")+".size"],viewSize:o[tooltip.getMapControlFor("map")+".view-size"]};try{tooltip.mapOffsets=$.parseJSON(o[tooltip.getMapControlFor("helper")+".saved-params"])}catch(t){return void triggerError("(updateCallback helper saved-params) JSON parse error for: "+o[tooltip.getMapControlFor("helper")+".saved-params"]+". "+t)}tooltip.debugLog("updateCallback called. map: "+JSON.stringify(o)+". params: "+JSON.stringify(tooltip.params)+". clientViewX: "+tooltip.clientViewX+". clientViewY: "+tooltip.clientViewY+". title: "+htmlEntities(tooltip.options.title)+". theme: "+tooltip.options.theme+". interrupt: "+tooltip.interrupt),window.location="byond://winset?id="+tooltip.interface+";pos="+tooltip.map.viewSize.x+",0;size=999x999;alpha=0",tooltip.$docBody.attr("class",tooltip.options.theme+(tooltip.pinned?" pinned":"")),tooltip.$wrap.attr("style",""),tooltip.changeContent(tooltip.options.title,tooltip.options.content)},update:function(o,i,t,e,p){try{tooltip.params=$.parseJSON(o)}catch(t){return void triggerError("(update params) JSON parse error for: "+o+". "+t)}tooltip.params.hasOwnProperty("init")&&tooltip.init(tooltip.params.init.screen,tooltip.params.init.iconSize,tooltip.params.init.window,tooltip.params.init.map);try{tooltip.options=$.parseJSON(i)}catch(t){return void triggerError("(update options) JSON parse error for: "+i+". "+t)}tooltip.removeDelays(),tooltip.interrupt=!1,tooltip.clientViewX=parseInt(t),tooltip.clientViewY=parseInt(e),tooltip.pinned="1"===p,window.location="byond://winget?callback="+tooltip.interface+":tooltip.updateCallback;id="+tooltip.getMapControlFor("map")+","+tooltip.getMapControlFor("helper")+";property=pos,size,view-size,saved-params"}};$(window).on("load",function(){!1===tooltip.loaded&&(tooltip.loaded=!0,tooltip.debugLog("JS loaded, calling topic show"),window.location="?src="+window.tooltipRef+";action=show",tooltip.$docBody=$("body"),tooltip.$wrap=$("#wrap"),tooltip.$content=$("#content"))});