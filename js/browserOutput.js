var $messages,$subOptions,$contextMenu,$filterMessages,$playMusic,$lastEntry,div,triggerError=attachErrorHandler("chatDebug",!0),escaper=encodeURIComponent||escape,decoder=decodeURIComponent||unescape,opts={messageCount:0,messageLimit:4e3,scrollSnapTolerance:20,clickTolerance:10,popups:0,wasd:!(window.status="Output"),chatMode:"default",priorChatHeight:0,restarting:!1,volume:.5,lastMessage:"",maxStreakGrowth:20,messageClasses:["admin","combat","radio","say","ooc","internal"],subOptionsLoop:null,suppressOptionsClose:!1,highlightTerms:[],highlightLimit:10,highlightColor:"#FFFF00",pingDisabled:!1,twemoji:!1,messageLimitEnabled:!0,pingCounter:0,pingLimit:10,pingTime:0,pongTime:0,noResponse:!1,noResponseCount:0,mouseDownX:null,mouseDownY:null,preventFocus:!1,adminLoaded:!1,clientDataLimit:5,clientData:[],currentTheme:"theme-default"},themes={"theme-default":"Windows 3.1 (default)","theme-dark":"Dark"};function createHighlightMarkup(){var e="";return opts.highlightColor&&(e+=' style="background-color: '+opts.highlightColor+'"'),'<span class="highlight"'+e+"></span>"}function getTextNodes(e,o){var s=$([]);return $(e).contents().each(function(e,t){s=3===t.nodeType&&/\S/.test(t.nodeValue)&&-1!==t.nodeValue.search(o)?s.add(t):s.add(getTextNodes(t,o))}),s}function highlightTerms(e){var a=new RegExp("("+opts.highlightTerms.join("|")+")","gi");getTextNodes(e,a).each(function(e,t){var o=$(t),s=o.text(),n=o.parent(),i=$(t.previousSibling);o.remove(),s.split(a).forEach(function(e){var t,o=null,o=a.test(e)?((t=$(createHighlightMarkup())).text(e),t):document.createTextNode(e);i=0==i.length?(e=n.prepend(o),$(e[0].firstChild)):(i.after(o),$(i[0].nextSibling))})})}function handleStreakCounter(e){var t,o=e.find(".streak-counter");o.length?(t=o.data("count"),t++,o.text("x"+t).data("count",t),t<=opts.maxStreakGrowth&&e.css("font-size",1+.05*t+"em")):e.css("font-size","1.1em").append($("<span>",{class:"streak-counter",text:"x2"}).data("count",2))}function parseEmojis(e){if(opts.twemoji)return twemoji.parse(e,{folder:"svg",ext:".svg"});return e.replace(/((?:\u00a9|\u00ae|[\u2000-\u3300]|\ud83c[\ud000-\udfff]|\ud83d[\ud000-\udfff]|\ud83e[\ud000-\udfff])+)/g,'<span class="emoji">$1</span>')}function output(e,t,o,s){if(void 0!==e){void 0===t&&(t=""),("string"==typeof o||o instanceof String)&&(o=parseInt(o)),("string"==typeof s||s instanceof String)&&(s=parseInt(s));var n,i,a=!1;if(o||(n=$("body").height(),i=$messages.outerHeight(),n+document.documentElement.scrollTop>=i-opts.scrollSnapTolerance||s?(a=!0,$("#newMessages").length&&$("#newMessages").remove()):$("#newMessages").length?(l=$("#newMessages .number").text(),l=parseInt(l),l++,$("#newMessages .number").text(l),2==l&&$("#newMessages .messageWord").append("s")):$messages.after('<a href="#" id="newMessages"><span class="number">1</span> new <span class="messageWord">message</span> <i class="icon-double-angle-down"></i></a>')),e=parseEmojis(e),opts.messageCount++,opts.messageCount>=opts.messageLimit&&opts.messageLimitEnabled&&!o&&($messages.children("div.entry:nth-child(-n+"+opts.messageLimit/2+")").remove(),opts.messageCount-=opts.messageLimit/2),e===opts.lastMessage)handleStreakCounter($lastEntry),opts.messageCount--;else{var r=null;if(t&&$lastEntry.hasClass("hasGroup")&&$lastEntry.data("group")===t){var r=$lastEntry[0],s=$lastEntry.find(".streak-counter"),l=null;s.length&&(l=s.clone(!0)),$lastEntry.html(e),l&&$lastEntry.append(l),handleStreakCounter($lastEntry),opts.messageCount--}else{(r=document.createElement("div")).className="entry",t&&(r.className+=" hasGroup",r.setAttribute("data-group",t));let o=!1,s=$("<span>"+e+"</span>");$.each(opts.messageClasses,function(e,t){0===s.find("."+t).length&&!s.hasClass(t)||(r.className+=" "+t,o=!0)}),o||(r.className+=" misc"),r.innerHTML=e,$lastEntry=$($messages[0].appendChild(r)),opts.lastMessage=e}opts.highlightTerms&&0<opts.highlightTerms.length&&highlightTerms(r)}a&&!o&&window.scrollTo(0,document.body.scrollHeight)}}function outputBatch(e){for(var t=JSON.parse(e),o=$("body").height(),e=$messages.outerHeight(),s=o+document.documentElement.scrollTop>=e-opts.scrollSnapTolerance,n=0;n<t.length;n++)output(t[n].message,t[n].group,n<t.length-1,s||t[n].forceScroll)}function runByond(e){window.location=e}function setCookie(e,t,o){t=escaper(t);var s=new Date;s.setTime(s.getTime()+24*o*60*60*1e3);s=e+"="+t+"; "+("expires="+s.toUTCString())+"; path=/";document.cookie=s}function getCookie(e){for(var t=e+"=",o=document.cookie.split(";"),s=0;s<o.length;s++){for(var n=o[s];" "==n.charAt(0);)n=n.substring(1);if(0===n.indexOf(t))return decoder(n.substring(t.length,n.length))}return""}function rgbToHex(e,t,o){return toHex(e)+toHex(t)+toHex(o)}function toHex(e){return e=parseInt(e,10),isNaN(e)?"00":(e=Math.max(0,Math.min(e,255)),"0123456789ABCDEF".charAt((e-e%16)/16)+"0123456789ABCDEF".charAt(e%16))}function changeMode(e){switch(e){case"geocities":case"console":opts.chatMode=e;break;case"default":default:opts.chatMode="default"}}function changeTheme(e){var t=$("body");t.removeClass(opts.currentTheme),t.addClass(e),setCookie("theme",opts.currentTheme=e,365)}function handleClientData(e,t,o){var s={ckey:e,ip:t,compid:o};if(opts.clientData&&!$.isEmptyObject(opts.clientData)){runByond("?action=ehjax&type=datum&datum=chatOutput&proc=analyzeClientData&param[cookie]="+JSON.stringify({connData:opts.clientData}));for(var n=0;n<opts.clientData.length;n++){var i=opts.clientData[n];if(s.ckey==i.ckey&&s.ip==i.ip&&s.compid==i.compid)return}opts.clientData.length>=opts.clientDataLimit&&opts.clientData.shift()}else runByond("?action=ehjax&type=datum&datum=chatOutput&proc=analyzeClientData&param[cookie]=none");opts.clientData.push(s),setCookie("connData",JSON.stringify(opts.clientData),365)}function ehjaxCallback(o){var e,t,s;if("pong"==o)opts.pingDisabled||(opts.pongTime=Date.now(),e=Math.ceil((opts.pongTime-opts.pingTime)/2),$("#pingMs").text(e+"ms"),e=rgbToHex(e=Math.min(e,255),255-e,0),$("#pingDot").css("color","#"+e));else if("roundrestart"==o||"hardrestart"==o)opts.restarting=!0,output('<div class="connectionClosed internal restarting">The connection has been closed because the server is restarting. Please wait while you automatically reconnect.</div>'),"hardrestart"==o&&setTimeout(function(){runByond("byond://winset?command=.reconnect"),output('<span class="internal boldnshit">Auto reconnecting from hard restart...</span>')},6e4);else if("stopaudio"==o)$(".dectalk").remove(),window.HTMLAudioElement&&$playMusic.get(0).pause();else{try{t=$.parseJSON(o)}catch(e){return void triggerError("(ehjaxCallback data) JSON parse error for: "+o+". "+e)}if((o=t).clientData)opts.restarting&&(opts.restarting=!1,$(".connectionClosed.restarting:not(.restored)").addClass("restored").text("The round restarted and you successfully reconnected!")),(o.clientData.ckey||o.clientData.ip||o.clientData.compid)&&handleClientData(o.clientData.ckey,o.clientData.ip,o.clientData.compid);else if(o.changeTheme)changeTheme(o.changeTheme);else if(o.loadAdminCode)opts.adminLoaded||(s=o.loadAdminCode,$("body").append(s),opts.adminLoaded=!0);else if(o.loadPerfMon)opts.perfMonLoaded||(s=o.loadPerfMon,$("body").append(s),opts.perfMonLoaded=!0);else if(o.modeChange)changeMode(o.modeChange);else if(o.firebug){o.trigger?output('<span class="internal boldnshit">Loading firebug console, triggered by '+o.trigger+"...</span>"):output('<span class="internal boldnshit">Loading firebug console...</span>');var n=document.createElement("script");n.src="https://getfirebug.com/firebug-lite-debug.js",document.body.appendChild(n)}else if(o.dectalk){n='<audio class="dectalk" src="'+o.dectalk+'" autoplay="autoplay"></audio>';output(n=o.decTalkTrigger?'<a href="#" class="stopAudio icon-stack" title="Stop Audio" style="color: black;"><i class="icon-volume-off"></i><i class="icon-ban-circle" style="color: red;"></i></a> <span class="italic">You hear a strange robotic voice...</span>'+n:n,"preventLink")}else if(o.playMusic)if(window.HTMLAudioElement)try{("number"!=typeof o.volume||o.volume<0||1<o.volume)&&(o.volume=opts.volume),$playMusic.attr("src",o.playMusic);var i=$playMusic.get(0);i.volume=.5*o.volume,i.paused&&i.play()}catch(e){triggerError("PlayMusic: "+e+". "+JSON.stringify(o))}else output('<span class="internal boldnshit">Your IE version is too old for this music. Please upgrade to IE 9+.</span>');else o.adjustVolume,"number"!=typeof o.adjustVolume||o.adjustVolume<0||1<o.adjustVolume||(opts.volume=o.adjustVolume,window.HTMLAudioElement&&($playMusic.get(0).volume=o.adjustVolume,$(".dectalk").each(function(e,t){t.volume=o.adjustVolume})))}}function createPopup(e,t){opts.popups++,$("body").append('<div class="popup" id="popup'+opts.popups+'" style="width: '+t+'px;">'+e+' <a href="#" class="close"><i class="icon-remove"></i></a></div>');var o=$("#popup"+opts.popups),e=o.outerHeight();o.css({height:e+"px",margin:"-"+e/2+"px 0 0 -"+t/2+"px"}),o.on("click",".close",function(e){e.preventDefault(),o.remove()})}function toggleWasd(e){opts.wasd="on"==e}Date.now||(Date.now=function(){return(new Date).getTime()}),"function"!=typeof String.prototype.trim&&(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),"undefined"==typeof $&&(div=document.getElementById("loading").childNodes[1],div+="<br><br>ERROR: Jquery did not load.");var readyCalled=!1;$(function(){var e,t,o,s;readyCalled||(readyCalled=!0,$messages=$("#messages"),$subOptions=$("#subOptions"),$playMusic=$("#play-music"),setInterval(function(){var e;opts.pingCounter>=opts.pingLimit&&!opts.restarting?(e=(opts.pongTime-opts.pingTime)/2,opts.pingCounter=0,opts.pongTime=0,opts.pingTime=Date.now(),runByond("?action=ehjax&window=browseroutput&type=datum&datum=chatOutput&proc=ping&param[last_ping]="+e),setTimeout(function(){opts.pongTime?opts.noResponse&&($('.connectionClosed[data-count="'+opts.noResponseCount+'"]:not(.restored)').addClass("restored").text("Your connection has been restored (probably)!"),opts.noResponse=!1):opts.noResponse||(opts.noResponse=!0,opts.noResponseCount++,output('<div class="connectionClosed internal" data-count="'+opts.noResponseCount+'">You are either experiencing lag or the connection has closed.</div>'))},1e4)):opts.pingCounter++},1e3),(s={sfontSize:getCookie("fontsize"),sfontType:getCookie("fonttype"),spingDisabled:getCookie("pingdisabled"),shighlightTerms:getCookie("highlightterms"),shighlightColor:getCookie("highlightcolor"),stheme:getCookie("theme"),stwemoji:getCookie("twemoji"),smessageLimitEnabled:getCookie("messageLimitEnabled")}).sfontSize&&($messages.css("font-size",s.sfontSize),output('<span class="internal boldnshit">Loaded font size setting of: '+s.sfontSize+"</span>")),s.sfontType&&($messages.css("font-family",s.sfontType),output('<span class="internal boldnshit">Loaded font type setting of: '+s.sfontType+"</span>")),s.spingDisabled&&("true"==s.spingDisabled&&(opts.pingDisabled=!0,$("#ping").hide()),output('<span class="internal boldnshit">Loaded ping display of: '+(opts.pingDisabled?"hidden":"visible")+"</span>")),!s.shighlightTerms||(t=0!=(e=$.parseJSON(s.shighlightTerms).filter(function(e){return null!==e&&/\S/.test(e)})).length?e.join(", "):null)&&(output('<span class="internal boldnshit">Loaded highlight strings of: '+t+"</span>"),opts.highlightTerms=e),s.shighlightColor&&(opts.highlightColor=s.shighlightColor,output('<span class="internal boldnshit">Loaded highlight color of: '+s.shighlightColor+"</span>")),s.stheme&&((o=$("body")).removeClass(opts.currentTheme),o.addClass(s.stheme),opts.currentTheme=s.stheme,output('<span class="internal boldnshit">Loaded theme setting of: '+themes[s.stheme]+"</span>")),s.stwemoji&&(opts.twemoji=!0),s.smessageLimitEnabled&&(opts.messageLimitEnabled=s.smessageLimitEnabled),function(){var e,t=getCookie("connData");if(t){try{e=$.parseJSON(t)}catch(e){return triggerError("(cookie connData) JSON parse error for: "+t+". "+e)}opts.clientData=e}}(),$("body").on("click","a",function(e){e.preventDefault()}),$("body").on("mousedown",function(e){var t=$(e.target);if($contextMenu&&opts.hasOwnProperty("contextMenuTarget")&&opts.contextMenuTarget)return hideContextMenu(),!1;t.is("a")||t.parent("a").length||t.is("input")||t.is("textarea")?opts.preventFocus=!0:(opts.preventFocus=!1,opts.mouseDownX=e.pageX,opts.mouseDownY=e.pageY)}),$messages.on("mousedown",function(e){$subOptions&&$subOptions.is(":visible")&&($subOptions.slideUp("fast",function(){$(this).removeClass("scroll"),$(this).css("height","")}),clearInterval(opts.subOptionsLoop))}),$("body").on("mouseup",function(e){!opts.preventFocus&&e.pageX>=opts.mouseDownX-opts.clickTolerance&&e.pageX<=opts.mouseDownX+opts.clickTolerance&&e.pageY>=opts.mouseDownY-opts.clickTolerance&&e.pageY<=opts.mouseDownY+opts.clickTolerance&&(opts.mouseDownX=null,opts.mouseDownY=null,runByond("byond://winset?mainwindow.input.focus=true"))}),$messages.on("click","a",function(e){e.preventDefault();e=$(this).attr("href");"?"==e[0]||8<=e.length&&"byond://"==e.substring(0,8)?runByond(e):runByond("?action=openLink&link="+(e=escaper(e)))}),$("body").on("keydown",function(e){if("INPUT"!=e.target.nodeName&&"TEXTAREA"!=e.target.nodeName&&!(e.ctrlKey||e.altKey||e.shiftKey)){var t=String.fromCharCode(e.which);return runByond(t?"byond://winset?mainwindow.input.focus=true;mainwindow.input.text="+(t=!e.shiftKey?t.toLowerCase():t):"byond://winset?mainwindow.input.focus=true"),!1}}),$(window).on("resize",function(e){$(this).height()!==opts.priorChatHeight&&($("body,html").scrollTop($messages.outerHeight()),opts.priorChatHeight=$(this).height())}),$messages.on("click",".stopAudio",function(){var e=$(this).parent().children("audio");e&&e.remove()}),$(window).on("scroll",function(){var e=$("body").height(),t=$messages.outerHeight();e+$("body,html").scrollTop()>=t-opts.scrollSnapTolerance&&$("#newMessages").length&&$("#newMessages").remove()}),$("body").on("click","#newMessages",function(e){var t=$messages.outerHeight();$("body,html").scrollTop(t),$("#newMessages").remove()}),$("#toggleOptions").click(function(e){$subOptions.is(":visible")?($subOptions.slideUp("fast",function(){$(this).removeClass("scroll"),$(this).css("height","")}),clearInterval(opts.subOptionsLoop)):($subOptions.slideDown("fast",function(){var e=$(window).height(),t=$("#toggleOptions").outerHeight(),o=$subOptions.outerHeight(),s=e-t;$(this).height(s),e-t<o&&$(this).addClass("scroll")}),opts.subOptionsLoop=setInterval(function(){},5e3))}),$("#subOptions, #toggleOptions").mouseenter(function(){opts.suppressOptionsClose=!0}),$("#subOptions, #toggleOptions").mouseleave(function(){opts.suppressOptionsClose=!1}),$("#decreaseFont").click(function(e){var t=(t=parseInt($messages.css("font-size")))-1+"px";$messages.css({"font-size":t}),setCookie("fontsize",t,365),output('<span class="internal boldnshit">Font size set to '+t+"</span>")}),$("#increaseFont").click(function(e){var t=(t=parseInt($messages.css("font-size")))+1+"px";$messages.css({"font-size":t}),setCookie("fontsize",t,365),output('<span class="internal boldnshit">Font size set to '+t+"</span>")}),$("#chooseFont").click(function(e){$(".popup .changeFont").is(":visible")||createPopup('<div class="head">Change Font</div><div id="changeFont" class="changeFont"><a href="#" data-font="\'Helvetica Neue\', Helvetica, Arial" style="font-family: \'Helvetica Neue\', Helvetica, Arial;">Arial / Helvetica (Default)</a><a href="#" data-font="Times New Roman" style="font-family: Times New Roman;">Times New Roman</a><a href="#" data-font="Georgia" style="font-family: Georgia;">Georgia</a><a href="#" data-font="Verdana" style="font-family: Verdana;">Verdana</a><a href="#" data-font="Wingdings" style="font-family: Wingdings;">Wingdings</a><a href="#" data-font="Comic Sans MS" style="font-family: Comic Sans MS;">Comic Sans MS</a><a href="#" data-font="Courier New" style="font-family: Courier New;">Courier New</a><a href="#" data-font="Lucida Console" style="font-family: Lucida Console;">Lucida Console</a></div>',200)}),$("body").on("click","#changeFont a",function(e){var t=$(this).attr("data-font");$messages.css("font-family",t),setCookie("fonttype",t,365)}),$("#chooseTheme").click(function(e){var o;$(".popup .changeTheme").is(":visible")||(o='<div class="head">Change Theme</div><div id="changeTheme" class="changeTheme">',$.each(themes,function(e,t){o=o+'<a href="#" data-theme="'+e+'">'+t+"</a>"}),createPopup(o+="</div>",200))}),$("body").on("click","#changeTheme a",function(e){changeTheme($(this).attr("data-theme"))}),$("#togglePing").click(function(e){opts.pingDisabled?($("#ping").slideDown("fast"),opts.pingDisabled=!1):($("#ping").slideUp("fast"),opts.pingDisabled=!0),setCookie("pingdisabled",opts.pingDisabled?"true":"false",365)}),$("#toggleEmojiFont").click(function(e){opts.twemoji=!opts.twemoji,setCookie("twemoji",opts.twemoji,365),output('<span class="internal boldnshit">Emoji set to '+(opts.twemoji?"Twemoji":"Windows emoji")+"</span>")}),$("#toggleMessageLimit").click(function(e){opts.messageLimitEnabled=!opts.messageLimitEnabled,setCookie("messageLimitEnabled",opts.messageLimitEnabled,365),output('<span class="internal boldnshit">'+(opts.messageLimitEnabled?"Old messages will get deleted.":"Old messages no longer get deleted. This might cause performance issues.")+"</span>")}),$("#saveLog").click(function(e){var t="";xmlHttp=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),xmlHttp.open("GET","https://cdn.goonhub.com/css/browserOutput.css",!1),xmlHttp.setRequestHeader("Content-type","application/x-www-form-urlencoded"),xmlHttp.send(),t+="<style>"+xmlHttp.responseText+"</style>",t+='<body class="'+opts.currentTheme+'">',t+=$messages.html(),t+="</body>";var o=new Date,o="log_"+o.getFullYear()+"-"+(o.getMonth()+1)+"-"+o.getDate()+"_"+o.getHours()+"-"+o.getMinutes()+".html";navigator.msSaveBlob(new Blob([t],{type:"text/html"}),o)}),$("#highlightTerm").click(function(e){if(!$(".popup .highlightTerm").is(":visible")){for(var t="",o=0;o<opts.highlightLimit;o++)t+='<div><input type="text" name="highlightTermInput'+o+'" id="highlightTermInput'+o+'" class="highlightTermInput'+o+'" maxlength="255" value="'+(opts.highlightTerms[o]||"")+'" /></div>';createPopup('<div class="head">String Highlighting</div><div class="highlightPopup" id="highlightPopup"><div>Choose up to '+opts.highlightLimit+' strings that will highlight the line when they appear in chat.</div><form id="highlightTermForm">'+t+'<div><input type="text" name="highlightColor" id="highlightColor" class="highlightColor" style="background-color: '+(opts.highlightColor||"#FFFF00")+'" value="'+(opts.highlightColor||"#FFFF00")+'" maxlength="7" /></div><div><input type="submit" name="highlightTermSubmit" id="highlightTermSubmit" class="highlightTermSubmit" value="Save" /></div></form></div>',250)}}),$("body").on("keyup","#highlightColor",function(){var e=$("#highlightColor").val();(e=e.trim())&&"#"==e.charAt(0)&&$("#highlightColor").css("background-color",e)}),$("body").on("submit","#highlightTermForm",function(e){e.preventDefault(),opts.highlightTerms=[];for(var t=0;t<opts.highlightLimit;t++){var o=$("#highlightTermInput"+t).val();null!==o&&/\S/.test(o)&&opts.highlightTerms.push(o.trim().toLowerCase())}e=$("#highlightColor").val();""==(e=e.trim())||"#"!=e.charAt(0)?opts.highlightColor="#FFFF00":opts.highlightColor=e,$("#highlightPopup").closest(".popup").remove(),setCookie("highlightterms",JSON.stringify(opts.highlightTerms),365),setCookie("highlightcolor",opts.highlightColor,365)}),$("#clearMessages").click(function(){$messages.empty(),opts.messageCount=0}),$("body").on("click",".browser-warning .close",function(e){e.preventDefault(),$(".browser-warning").remove()}),o=navigator.userAgent.match(/Trident\/(\d)\.\d(?:;|$)/gi),((s=document.documentMode)&&s<10||o&&parseInt(o)<6)&&$("body").append('<div class="browser-warning">BYOND uses IE for interfaces and we\'ve detected yours is very old.<br><strong>Please consider upgrading or some stuff might be broken for you!</strong><a href="#" class="close"><i class="icon-remove"></i></a></div>'),runByond("?action=ehjax&type=datum&datum=chatOutput&proc=doneLoading&param[ua]="+escaper(navigator.userAgent)),$("#loading").is(":visible")&&$("#loading").remove(),$("#userBar").show(),opts.priorChatHeight=$(window).height())});